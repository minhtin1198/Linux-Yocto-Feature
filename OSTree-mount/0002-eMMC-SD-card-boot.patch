From 5ceb4cdc7d0571fbce0cd141587025c228bd690f Mon Sep 17 00:00:00 2001
From: tnguyen6 <Tin.Nguyen@windriver.com>
Date: Mon, 30 Dec 2024 11:00:32 +0700
Subject: [PATCH 2/2] eMMC SD card boot

---
 recipes-bsp/u-boot/u-boot-uenv_2.0.bb         |  5 +++-
 .../initrdscripts/files/init-ostree.sh        | 23 +++++++++++++------
 2 files changed, 20 insertions(+), 8 deletions(-)

diff --git a/recipes-bsp/u-boot/u-boot-uenv_2.0.bb b/recipes-bsp/u-boot/u-boot-uenv_2.0.bb
index d70fd53..2fd442a 100644
--- a/recipes-bsp/u-boot/u-boot-uenv_2.0.bb
+++ b/recipes-bsp/u-boot/u-boot-uenv_2.0.bb
@@ -166,6 +166,9 @@ fi
 if test ! -n "\${devnum}"; then
  setenv devnum 0
 fi
+
+setenv devnum \${mmcdev}
+
 setenv devcmd \${devtype}
 fatload \${devtype} \${devnum}:1 \${loadaddr} no_ab
 if test \${filesize} = 1;then setenv ex;setenv B \$A;fi
@@ -363,7 +366,7 @@ else
   setenv loadkernel ext4load \${devtype} \${devnum}:\${mmcpart} \${loadaddr} \${ostver}/vmlinuz
   setenv loadramdisk ext4load \${devtype} \${devnum}:\${mmcpart} \${initrd_addr} \${ostver}/initramfs
 fi
-setenv bootargs "\${fdtargs} \${bootpart} ostree=/ostree/\${ostver} \${rootpart} ${OSTREE_CONSOLE} ${OSTREE_BSP_ARGS} \${smp} flux=fluxdata\${labelpre}"
+setenv bootargs "\${fdtargs} \${bootpart} ostree=/ostree/\${ostver} \${rootpart} ${OSTREE_CONSOLE} ${OSTREE_BSP_ARGS} \${smp} flux=fluxdata\${labelpre} devnum=\${devnum}"
 if test "\${no_fatwrite}" = yes; then
  setenv bootargs "\${bootargs} no_fatwrite=yes"
 fi
diff --git a/recipes-sota/initrdscripts/files/init-ostree.sh b/recipes-sota/initrdscripts/files/init-ostree.sh
index be1775c..ed70864 100644
--- a/recipes-sota/initrdscripts/files/init-ostree.sh
+++ b/recipes-sota/initrdscripts/files/init-ostree.sh
@@ -101,6 +101,8 @@ read_args() {
 				OSTREE_LABEL_FLUXDATA=$optarg ;;
 			devmd=*)
 				DEVMD=$optarg ;;
+			devnum=*)
+				OSTREE_DEVNUM=$optarg ;;
 		esac
 	done
 }
@@ -111,10 +113,10 @@ expand_fluxdata() {
 	[ -z $fluxdata_label ] && return 0
 
 	# expanding FLUXDATA
-	datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" |head -n 1| awk -F: '{print $1}')
+	datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
 	# Check for luksfluxdata expansion if the volume is not set initialized
 	[ -z ${datapart} ] && {
-		datapart=$(blkid -s LABEL | grep "LABEL=\"luks$fluxdata_label\"" |head -n 1| awk -F: '{print $1}')
+		datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
 		[ -z ${datapart} ] && return 0
 	}
 
@@ -125,6 +127,7 @@ expand_fluxdata() {
 	disk_sect=`fdisk -l /dev/$datadev | head -n 1 |awk '{print $7}'`
 	part_end=`fdisk -l /dev/$datadev | grep ^${datapart} | awk '{print $3}'`
 	disk_end=$(expr $disk_sect - 1026)
+
 	if [ $part_end -ge $disk_end ]; then
 		echo "No fluxdata expansion." && return 0
 	fi
@@ -205,7 +208,7 @@ rm_var_check() {
 	fi
 	fluxdata_label=$OSTREE_LABEL_FLUXDATA
 	[ -z $fluxdata_label ] && return 0
-	datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" |head -n 1| awk -F: '{print $1}')
+	datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
 	if [ -n $datapart ] ; then
 		reboot_flag=0
 		if [ -e "/sys/fs/selinux" ];then
@@ -252,7 +255,8 @@ try_to_mount_rootfs() {
 	local mount_flags="rw,noatime${IVERSION}"
 	mount_flags="${mount_flags},${ROOT_FLAGS}"
 
-	mount -o $mount_flags "${OSTREE_ROOT_DEVICE}" "${ROOT_MOUNT}" 2>/dev/null && return 0
+	rootpart=$(blkid -s LABEL | grep "LABEL=\"${OSTREE_ROOT_DEVICE#LABEL=}\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
+	mount -o $mount_flags "${rootpart}" "${ROOT_MOUNT}" 2>/dev/null && return 0
 }
 
 # For slow disks we must wait for the labels to become ready
@@ -296,8 +300,10 @@ fi
 
 timeout=$(($MAX_TIMEOUT_FOR_WAITING_LOWSPEED_DEVICE * 10))
 do_echo=1
+
 while [ 1 ] ; do
-	mount "${OSTREE_BOOT_DEVICE}" "${ROOT_MOUNT}/boot" && break
+	bootpart=$(blkid -s LABEL | grep "LABEL=\"${OSTREE_BOOT_DEVICE#LABEL=}\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
+	mount "${bootpart}" "${ROOT_MOUNT}/boot" && break
 	[ $do_echo = 1 ] && echo "Waiting for boot device to be ready..." && do_echo=0
 	sleep 0.1
 	timeout=$(($timeout - 1))
@@ -321,8 +327,11 @@ if [ -n "$has_immutable_test" ]; then
 	fi
 fi
 
-sed "/LABEL=otaboot[\t ]*\/boot[\t ]/s/LABEL=otaboot/${OSTREE_BOOT_DEVICE}/g" -i ${ROOT_MOUNT}/etc/fstab
-sed "/LABEL=otaboot_b[\t ]*\/boot[\t ]/s/LABEL=otaboot_b/${OSTREE_BOOT_DEVICE}/g" -i ${ROOT_MOUNT}/etc/fstab
+bootpart=$(blkid -s LABEL | grep "LABEL=\"${OSTREE_BOOT_DEVICE#LABEL=}\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
+sed "/\/boot[\t ]*auto/s|.*|${bootpart}    /boot    auto   defaults 0 0|" -i ${ROOT_MOUNT}/etc/fstab
+
+datapart=$(blkid -s LABEL | grep "LABEL=\"$fluxdata_label\"" | awk -F: '{print $1}' | grep -E "/dev/mmcblk${OSTREE_DEVNUM}")
+sed "/\/var[\t ]*auto/s|.*|${datapart}    /var    auto   defaults 0 0|" -i ${ROOT_MOUNT}/etc/fstab
 
 which ostree 2>/dev/null && has_ostree_cmd=1
 
-- 
2.46.1

